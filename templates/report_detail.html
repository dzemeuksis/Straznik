{% extends 'base.html' %}
{% block content %}
<h1>Szczegóły zgłoszenia</h1>
<!-- Loading overlay -->
<div id="loading-overlay" style="position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(255,255,255,0.8);z-index:1050;display:none;align-items:center;justify-content:center;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Wysyłanie...</span>
  </div>
</div>
<!-- Formularz dodawania nowej aktualizacji (najpierw) -->
<form id="add-entry-form" method="post" enctype="multipart/form-data">
  <input type="hidden" name="action" value="add_entry">
  <input type="hidden" name="lat" id="lat">
  <input type="hidden" name="lng" id="lng">
  <div class="mb-3">
    <label for="image" class="form-label">Zdjęcie</label>
    <input class="form-control" type="file" id="image" name="image" required>
  </div>
  <!-- Opcjonalny opis przesyłany w oddzielnej kolejności; nie wysyłamy w tym formularzu -->
  <!-- Pole opisu i przycisk zostały usunięte; formularz wysyła się automatycznie po wyborze zdjęcia -->
</form>
<hr class="my-4">
<!-- Wersje zgłoszenia od najnowszej do najstarszej -->
{% for entry in report.entries | reverse %}
  <div class="card mb-3">
    <div class="card-body">
      <p><strong>Data przesłania:</strong> {{ entry.timestamp }}</p>
      {% if entry.photo_time %}
      <p><strong>Czas wykonania zdjęcia:</strong> {{ entry.photo_time }}</p>
      {% endif %}
      {% if entry.device_location %}
      <p><strong>Lokalizacja urządzenia:</strong> {{ entry.device_location.lat }}, {{ entry.device_location.lng }}</p>
      {% endif %}
      {% if entry.exif_location %}
      <p><strong>Lokalizacja z EXIF:</strong> {{ entry.exif_location.lat }}, {{ entry.exif_location.lng }}</p>
      {% endif %}
      <img src="{{ url_for('main.uploaded_file', filename=entry.image_filename) }}" class="img-fluid mb-2">
      <h5>Opis AI</h5>
      <p>{{ entry.ai_description }}</p>
      <h5>Porada AI {% if loop.first %}
        <button type="button" id="dokladniej-btn" class="btn btn-secondary btn-sm ms-2">Dokładniej</button>
      {% endif %}</h5>
      <p>{{ entry.ai_advice }}</p>
      <h5>Twój opis</h5>
      {% if entry.user_description %}
        <p>{{ entry.user_description }}</p>
      {% endif %}
      <form method="post" class="mb-2">
        <input type="hidden" name="entry_id" value="{{ entry.entry_id }}">
        <input type="hidden" name="action" value="update_description">
        <div class="mb-2">
          <textarea class="form-control" name="user_description" rows="2" placeholder="Dodaj opis">{{ entry.user_description }}</textarea>
        </div>
        <button type="submit" class="btn btn-secondary btn-sm">Zapisz opis</button>
      </form>
    </div>
  </div>
{% endfor %}
<script>
  window.onload = () => {
    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        document.getElementById('lat').value = pos.coords.latitude;
        document.getElementById('lng').value = pos.coords.longitude;
      });
    }
    // Auto-submit form upon image selection
    const imgInput = document.getElementById('image');
    const addForm = document.getElementById('add-entry-form');
    function showLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.style.display = 'flex';
    }
    if (imgInput && addForm) {
      imgInput.addEventListener('change', () => addForm.submit());
      // On submit, show loading overlay and disable input
      addForm.addEventListener('submit', () => {
        imgInput.disabled = true;
        showLoading();
      });
    }
  };
</script>
{% endblock %}