{% extends 'base.html' %}
{% block content %}
<h1>Nowe zgłoszenie</h1>
<!-- Loading overlay -->
<div id="loading-overlay" style="position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(255,255,255,0.8);z-index:1050;display:none;align-items:center;justify-content:center;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Wysyłanie...</span>
  </div>
</div>
<form id="new-report-form" method="post" enctype="multipart/form-data">
  <div class="mb-3">
    <label for="image" class="form-label">Zdjęcie</label>
    <input class="form-control" type="file" id="image" name="image" required>
  </div>
  <input type="hidden" name="lat" id="lat">
  <input type="hidden" name="lng" id="lng">
  <!-- Przycisk został usunięty; formularz wysyła się automatycznie po wyborze zdjęcia -->
</form>
<script>
  window.onload = () => {
    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        document.getElementById('lat').value = pos.coords.latitude;
        document.getElementById('lng').value = pos.coords.longitude;
      });
    }
    // Auto-submit form upon image selection with disabling controls
    const imgInput = document.getElementById('image');
    const newForm = document.getElementById('new-report-form');
    function showLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.style.display = 'flex';
    }
    function disableAllControls() {
      // Disable form controls except file and hidden inputs to preserve file data and hidden fields
      document.querySelectorAll('input:not([type=file]):not([type=hidden]), button, textarea, select')
        .forEach(el => el.disabled = true);
    }
    if (imgInput && newForm) {
      imgInput.addEventListener('change', () => {
        disableAllControls();
        showLoading();
        newForm.submit();
      });
    }
  };
</script>
{% endblock %}